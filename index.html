<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>Weather Trends</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        body {
            font-family: sans-serif;
            padding: 2em;
        }

        svg {
            width: 100%;
            height: 400px;
        }

        #stationSelect {
            margin-bottom: 1em;
        }
    </style>
</head>

<body>
    <h1>Weather Temperature Trends</h1>
    <select id="stationSelect"></select>
    <svg id="chart"></svg>

    <script>
        const apiBase = "http://localhost:8000";

        async function loadStations() {
            const res = await fetch(`${apiBase}/stations`);
            const stations = await res.json();
            const select = document.getElementById("stationSelect");

            stations.forEach(station => {
                const opt = document.createElement("option");
                opt.value = station.id;
                opt.text = station.name;
                select.appendChild(opt);
            });

            select.addEventListener("change", () => {
                loadData(select.value);
            });

            loadData(select.value); // Load first by default
        }

        async function loadData(stationId) {
            const res = await fetch(`${apiBase}/data/${stationId}`);
            const data = await res.json();
            data.forEach(d => {
                d.date = new Date(d.date);
                d.avg_temp = +d.avg_temp;
            });

            drawChart(data);
        }

        function drawChart(data) {
            const svg = d3.select("#chart");
            svg.selectAll("*").remove();

            const margin = { top: 20, right: 30, bottom: 30, left: 50 },
                width = svg.node().clientWidth - margin.left - margin.right,
                height = svg.node().clientHeight - margin.top - margin.bottom;

            const g = svg.append("g").attr("transform", `translate(${margin.left},${margin.top})`);

            const x = d3.scaleTime().domain(d3.extent(data, d => d.date)).range([0, width]);
            const y = d3.scaleLinear().domain(d3.extent(data, d => d.avg_temp)).range([height, 0]);

            const line = d3.line()
                .x(d => x(d.date))
                .y(d => y(d.avg_temp))
                .curve(d3.curveMonotoneX);  // Smooth line

            g.append("path")
                .datum(data)
                .attr("fill", "none")
                .attr("stroke", "steelblue")
                .attr("stroke-width", 2)
                .attr("d", line);

            g.append("g")
                .attr("transform", `translate(0,${height})`)
                .call(d3.axisBottom(x));

            g.append("g").call(d3.axisLeft(y));
        }

        loadStations();
    </script>
</body>

</html>